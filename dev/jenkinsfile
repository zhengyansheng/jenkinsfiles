

// setBuildDisplayName è®¾ç½®æ„å»ºæ˜¾ç¤ºçš„åç§°
def setBuildDisplayName() {
    // å®šä¹‰æ—¥æœŸæ—¶é—´æ ¼å¼ï¼šå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’
    def dateFormat = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
    def currentDateTime = dateFormat.format(new Date())
    def description = currentBuild.displayName + "\n" + "$currentDateTime"
    currentBuild.description = "æ—¶é—´: $currentDateTime" + "\n" + "åˆ†æ”¯: xx" + "\n" + "ç¯å¢ƒ: xx" + "\n" + "ç”¨æˆ·: ${env.EXECUTE_JOB_USER_ID}"
}

// CheckoutCode å…‹éš†ä»£ç 
def checkoutCode(gitUrl, branch, credentialsId) {
    // Clean workspace before checking out code
    deleteDir()
    checkout scmGit(
        userRemoteConfigs: [[credentialsId:  credentialsId, url: gitUrl]],
        branches: [[name: branch]]
    )
}

// executeBuild æ‰§è¡Œæ„å»º
def executeBuild(codeType, serviceName, envName) {
    switch(codeType.toLowerCase()) {
        case 'java':
            buildJava()
            break
            
        case 'nodejs':
            buildNodejs()
            break
            
        case 'go':
            buildGolang()
            break
            
        default:
            error "ä¸æ”¯æŒçš„æ„å»ºç±»å‹: ${codeType}"
    }
}

def buildPushImage() {
    println("build push image")
}

def deployToCluster() {
    println("deployment")
}


def buildJava() {
    println("java")
}

def buildNodejs() {
    println("nodejs")
}

def buildGolang() {
    println("go")
}



// æµæ°´çº¿
pipeline {

    // æ‰§è¡Œçš„èŠ‚ç‚¹
    agent any

    // è¿è¡Œæ—¶å·¥å…·
    tools {
      go 'go123'
    }
    
    // ç¯å¢ƒå˜é‡
    environment {
      GOPROXY = "https://goproxy.cn,direct"
      // ä»“åº“è¯ä¹¦
      REPO_CREDENTID = "macmacmac"
    }


    // å‚æ•°
    parameters {
        choice(name: 'action', choices: ['æ„å»º', 'æ‰“åŒ…', 'éƒ¨ç½²', 'å›æ»š'], description: 'æ“ä½œçš„æŒ‡ä»¤')
        choice(name: 'branch', choices: ['master', 'qa', 'uat', 'dev'], description: 'åˆ†æ”¯æˆ–Tagåç§°')
    }

    // é˜¶æ®µ
    stages {
        stage('ğŸ”§ åˆå§‹åŒ– | Initialization') {
            steps {
                echo 'åˆå§‹åŒ–'
                
                wrap([$class: 'BuildUser']) {
                    script {
                        echo "è§¦å‘ç”¨æˆ·ID: ${env.BUILD_USER_ID}"      // å¦‚ 'admin'
                        env.EXECUTE_JOB_USER_ID = "${env.BUILD_USER_ID}"
                    }
                }
                
                script {

                    setBuildDisplayName()

                }
            }
        }

        stage('ğŸ“¥ æ£€å‡ºä»£ç  | Checkout Code') {
            steps {
                echo 'æ£€å‡ºä»£ç '
                
                script {

                    // TODO: åæœŸä½¿ç”¨å…±äº«åº“çš„æ–¹å¼
                    // å®šä¹‰å˜é‡å’Œå‡½æ•°
                    def serviceMap = [
                        "shark": [
                            "codeType": "go",
                            "repoUrl": "git@github.com:zhengyansheng/httpserver2.git"
                        ]
                    ]

                    def getServiceInfo = { String serviceName ->
                        return serviceMap.get(serviceName)
                    }



                    def info = getServiceInfo("shark")
                    if (info) {
                        // echo "ä»£ç ç±»å‹: ${info.codeType}"
                        // echo "ä»“åº“åœ°å€: ${info.repoUrl}"
                        checkoutCode(info.repoUrl, params.branch, env.REPO_CREDENTID)

                        // èµ‹å€¼ ä¸‹æ–‡å–
                        env.CODE_TYPE = info.codeType
                        // env.SERVICE_NAME = "shark"
                    } else {
                        error "æœåŠ¡ä¸å­˜åœ¨: shark"
                    }

                    sh '''
                    ls -l
                    pwd
                    '''
                    
                }
            }
        }

        stage('âš™ï¸ ç¼–è¯‘ | Build') {
            steps {
                echo 'ç¼–è¯‘'

                script {

                    // def codeType = env.CODE_TYPE  // env æ˜¯ Jenkins å†…ç½®ç¯å¢ƒå˜é‡å¯¹è±¡
                    // println(codeType)
                    executeBuild(env.CODE_TYPE, "shark", "dev")

                }
            }
        }

        stage('ğŸ³ æ„å»ºæ¨é€é•œåƒ | Build & Push Image') {
            steps {
                echo 'æ„å»ºå’Œæ¨é€é•œåƒ'

                script {

                    buildPushImage()

                }
            }
        }
        
        stage('ğŸš€ éƒ¨ç½² | Deployment') {
            steps {
                echo 'éƒ¨ç½²'

                script {

                    deployToCluster()

                }
            }
        }

    }

    // é’©å­
    post {
      always {
            script {
                println("jobæ‰§è¡Œç»“æŸ")
            }
      }
      aborted {
            script {
                println("jobç»ˆæ­¢")
            }
      }
      success {
            script {
                println("jobæ‰§è¡ŒæˆåŠŸ")
            }
      }
      failure {
            script {
                println("jobæ‰§è¡Œå¤±è´¥")
            }
      }
    }


}
